name: Padletã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ä¸€æ‹¬å–å¾—

on:
  schedule:
    # æ¯æ™‚0åˆ†ã«å®Ÿè¡Œ
    - cron: '0 * * * *'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  update-archives:
    runs-on: ubuntu-latest
    steps:
      - name: ãƒªãƒã‚¸ãƒˆãƒªã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4

      - name: ãƒ•ã‚©ãƒ«ãƒ€ä½œæˆã¨ãƒ‡ãƒ¼ã‚¿å–å¾—
        run: |
          # --- è¨­å®šã‚¨ãƒªã‚¢ ---
          
          # æ—¥æœ¬æ™‚é–“ã«è¨­å®š
          export TZ='Asia/Tokyo'
          
          # ä¿å­˜å…ˆã®ãƒ•ã‚©ãƒ«ãƒ€ã‚’ã¾ã¨ã‚ã¦ä½œæˆ
          mkdir -p archive/nyg archive/woolisbest archive/magurock archive/kiseikaijoiinkai

          # å¾…æ©Ÿæ™‚é–“ã‚’æ±ºå®š
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            SLEEP_TIME=3
          else
            SLEEP_TIME=10
          fi
          
          echo "ç¾åœ¨ã®ãƒ¢ãƒ¼ãƒ‰: ${{ github.event_name }}"
          echo "å¾…æ©Ÿæ™‚é–“: ${SLEEP_TIME}ç§’"

          # --- é–¢æ•°å®šç¾©ï¼ˆè³¢ã„æ¯”è¼ƒï¼‹æ—¥ä»˜ã‚’ã¤ã‘ã¦ä¿å­˜ã™ã‚‹å‡¦ç†ï¼‰ ---
          function save_padlet {
            local URL=$1
            local OUT_FILE=$2
            
            # 1. ä¸€æ—¦ãƒ‡ãƒ¼ã‚¿ã‚’ä¸€æ™‚ãƒ•ã‚¡ã‚¤ãƒ«ã«ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
            if curl -L --compressed -s -o temp_download.md "$URL"; then
                
                # 2. ä¸­èº«ã®ãƒã‚§ãƒƒã‚¯ï¼šå…ˆé ­ãŒ "<!DOCTYPE html>" ã ã£ãŸã‚‰ã‚¹ã‚­ãƒƒãƒ—
                if head -n 1 temp_download.md | grep -q "<!DOCTYPE html>"; then
                    echo "âš ï¸ ã‚¹ã‚­ãƒƒãƒ—: $OUT_FILE ã¯ã‚¨ãƒ©ãƒ¼ãƒšãƒ¼ã‚¸(HTML)ã§ã—ãŸã€‚æ›´æ–°ã—ã¾ã›ã‚“ã€‚"
                    rm temp_download.md
                    return 0
                fi

                # 3. å¤‰æ›´ãƒã‚§ãƒƒã‚¯ï¼ˆã“ã“ã‚’ä¿®æ­£ï¼šdiffã‚³ãƒãƒ³ãƒ‰ã§æ¯”è¼ƒï¼‰
                if [ -f "$OUT_FILE" ]; then
                    # æ—¢å­˜ãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ˜ãƒƒãƒ€ãƒ¼ï¼ˆ1,2è¡Œç›®ï¼‰ã‚’é™¤å¤–ã—ãŸã‚‚ã®ã‚’ä¸€æ™‚ä½œæˆ
                    tail -n +3 "$OUT_FILE" > current_body.tmp
                    
                    # diff -q ã§æ¯”è¼ƒï¼ˆ--strip-trailing-cr ã§æ”¹è¡Œã‚³ãƒ¼ãƒ‰ã®é•ã„ã‚’ç„¡è¦–ã—ã¦æ¯”è¼ƒï¼‰
                    if diff -q --strip-trailing-cr temp_download.md current_body.tmp > /dev/null; then
                        echo "âœ… å¤‰æ›´ãªã—: $OUT_FILE (æ›´æ–°æ—¥æ™‚ã‚‚ç¶­æŒã—ã¾ã™)"
                        rm temp_download.md current_body.tmp
                        return 0 # å¤‰æ›´ãŒãªã„ã®ã§çµ‚äº†
                    fi
                    
                    rm current_body.tmp
                fi

                # 4. å¤‰æ›´ãŒã‚ã£ãŸï¼ˆã¾ãŸã¯åˆå›ï¼‰å ´åˆã€ä¿å­˜å‡¦ç†ã‚’å®Ÿè¡Œ
                NOW=$(date "+%Y/%m/%d %H:%M:%S")
                
                # ãƒ˜ãƒƒãƒ€ãƒ¼ï¼ˆæ—¥æ™‚ã¨ç©ºè¡Œï¼‰ã‚’æ›¸ãè¾¼ã¿ï¼ˆä¸Šæ›¸ãï¼‰
                echo "æœ€çµ‚æ›´æ–°: $NOW" > "$OUT_FILE"
                echo "" >> "$OUT_FILE"
                
                # ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ãŸä¸­èº«ã‚’è¿½è¨˜
                cat temp_download.md >> "$OUT_FILE"
                
                # ä¸€æ™‚ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‰Šé™¤
                rm temp_download.md
                echo "ğŸ”„ æ›´æ–°å®Œäº†: $OUT_FILE ($NOW)"

            else
                echo "âŒ ã‚¨ãƒ©ãƒ¼: ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰å¤±æ•— $OUT_FILE"
            fi
            
            # ä¼‘æ†©
            sleep $SLEEP_TIME
          }

          # ==========================================
          # å®Ÿè¡Œã‚¨ãƒªã‚¢
          # ==========================================

          # --- 1. nyg ã‚·ãƒªãƒ¼ã‚º ---
          save_padlet "https://padlet.com/padlets/scvs0iw7tdatft21/exports/markdown.md" "archive/nyg/archive.md"
          save_padlet "https://padlet.com/padlets/ybtryru0lgzpxp34/exports/markdown.md" "archive/nyg/ssjc.md"
          save_padlet "https://padlet.com/padlets/lpiw7xio9gwnmxrd/exports/markdown.md" "archive/nyg/portalworld.md"
          save_padlet "https://padlet.com/padlets/i0fd897smvjo0tvj/exports/markdown.md" "archive/nyg/arashitaisaku.md"
          save_padlet "https://padlet.com/padlets/4b9092979b4e6dlm/exports/markdown.md" "archive/nyg/games.md"
          save_padlet "https://padlet.com/padlets/hqm4zg0lw3smlc23/exports/markdown.md" "archive/nyg/ssjt2025.md"

          # --- 2. woolisbest ã‚·ãƒªãƒ¼ã‚º ---
          save_padlet "https://padlet.com/padlets/99xq7bb7zjzcfzw0/exports/markdown.md" "archive/woolisbest/lobby.md"
          save_padlet "https://padlet.com/padlets/f46agi7nbsmz8boy/exports/markdown.md" "archive/woolisbest/main.md"
          save_padlet "https://padlet.com/padlets/wo6pj5yfmqsue2rh/exports/markdown.md" "archive/woolisbest/proxy.md"

          # --- 3. magurock ã‚·ãƒªãƒ¼ã‚º ---
          save_padlet "https://padlet.com/padlets/e9n4zhdx6ucfbaa4/exports/markdown.md" "archive/magurock/lobby.md"
          save_padlet "https://padlet.com/padlets/v7eblregk0t2eq0k/exports/markdown.md" "archive/magurock/main.md"

          # --- 4. kiseikaijoiinkai ã‚·ãƒªãƒ¼ã‚º ---
          save_padlet "https://padlet.com/padlets/5db70e80bto7rnxl/exports/markdown.md" "archive/kiseikaijoiinkai/lobby.md"

          # --- 5. ãã®ä»–ã®å˜ç‹¬ãƒ•ã‚¡ã‚¤ãƒ« ---
          save_padlet "https://padlet.com/padlets/zsdegt1d6scuq9qa/exports/markdown.md" "archive/beruri.md"
          save_padlet "https://padlet.com/padlets/fj7pwrjfd44519fq/exports/markdown.md" "archive/bonjour.md"
          save_padlet "https://padlet.com/padlets/afg5jcs1w4yyk2h1/exports/markdown.md" "archive/hikari.md"
          save_padlet "https://padlet.com/padlets/kulz2hpe9vtrxep4/exports/markdown.md" "archive/itrsa.md"
          save_padlet "https://padlet.com/padlets/34b6kq9lghbe3rtm/exports/markdown.md" "archive/kabotya.md"
          save_padlet "https://padlet.com/padlets/5ggicyna1yjvquxr/exports/markdown.md" "archive/obungu.md"

      - name: ã¾ã¨ã‚ã¦ä¿å­˜
        run: |
          git config --global user.name "GitHub Action Bot"
          git config --global user.email "action@github.com"
          
          # archiveãƒ•ã‚©ãƒ«ãƒ€å…¨ä½“ã‚’è¿½åŠ 
          git add archive/
          
          if git diff --staged --quiet; then
            echo "å¤‰æ›´ãŒãªã‹ã£ãŸã®ã§ä¿å­˜ã—ã¾ã›ã‚“"
          else
            git commit -m "ã‚¢ãƒ¼ã‚«ã‚¤ãƒ–ãƒ‡ãƒ¼ã‚¿ã‚’ä¸€æ‹¬æ›´æ–°"
            git pull origin main --rebase
            git push
          fi
