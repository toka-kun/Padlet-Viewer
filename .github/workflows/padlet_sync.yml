name: Padlet ãƒ‡ãƒ¼ã‚¿å–å¾— - Unblocked

on:
  schedule:
    - cron: '15/30 * * * *'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  get-padlet-data:
    runs-on: ubuntu-latest
    steps:
      - name: ãƒªãƒã‚¸ãƒˆãƒªã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆ
        uses: actions/checkout@v4

      - name: Padletã‹ã‚‰ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—
        run: |
          # ã‚¿ã‚¤ãƒ ã‚¾ãƒ¼ãƒ³ã‚’æ—¥æœ¬æ™‚é–“ã«è¨­å®š
          export TZ='Asia/Tokyo'
          
          # 1. ä¸€æ™‚ãƒ•ã‚¡ã‚¤ãƒ«ã«ãƒ‡ãƒ¼ã‚¿ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
          curl -L -s -o temp_download.md "https://padlet.com/padlets/a8v7cjbbfni702kg/exports/markdown.md"
          
          # 2. ä¸­èº«ã®ãƒã‚§ãƒƒã‚¯ï¼šå…ˆé ­ãŒ "<!DOCTYPE html>" ã ã£ãŸã‚‰ã‚¨ãƒ©ãƒ¼ã¨ã¿ãªã™
          if head -n 1 temp_download.md | grep -q "<!DOCTYPE html>"; then
            echo "âš ï¸ ã‚¨ãƒ©ãƒ¼: å–å¾—ã—ãŸãƒ‡ãƒ¼ã‚¿ãŒHTMLï¼ˆã‚¨ãƒ©ãƒ¼ãƒšãƒ¼ã‚¸ï¼‰ã§ã—ãŸã€‚æ›´æ–°ã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¾ã™ã€‚"
            rm temp_download.md
            exit 0
          fi

          # 3. å¤‰æ›´ãƒã‚§ãƒƒã‚¯ï¼ˆã“ã“ãŒé‡è¦ï¼‰
          # ã™ã§ã«ãƒ•ã‚¡ã‚¤ãƒ«ãŒå­˜åœ¨ã™ã‚‹å ´åˆã€ä¸­èº«ï¼ˆ3è¡Œç›®ä»¥é™ï¼‰ã‚’æ¯”è¼ƒã™ã‚‹
          if [ -f padlet_export.md ]; then
            # æ—¢å­˜ãƒ•ã‚¡ã‚¤ãƒ«ã®1,2è¡Œç›®ï¼ˆæ—¥ä»˜ãƒ˜ãƒƒãƒ€ãƒ¼ï¼‰ã‚’é™¤å¤–ã—ãŸã‚‚ã®ã‚’ä¸€æ™‚ä½œæˆ
            tail -n +3 padlet_export.md > current_body.tmp
            
            # ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ãŸã‚‚ã®ã¨æ¯”è¼ƒ
            if cmp -s temp_download.md current_body.tmp; then
               echo "âœ… å¤‰æ›´ãªã—: ãƒ‡ãƒ¼ã‚¿ã®ä¸­èº«ã¯åŒã˜ã§ã™ã€‚æ›´æ–°æ—¥æ™‚ã‚‚æ›´æ–°ã—ã¾ã›ã‚“ã€‚"
               rm temp_download.md current_body.tmp
               exit 0
            fi
            
            # ä¸€æ™‚ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‰Šé™¤ã—ã¦ã€æ›´æ–°å‡¦ç†ã¸é€²ã‚€
            rm current_body.tmp
          fi

          # 4. å¤‰æ›´ãŒã‚ã£ãŸï¼ˆã¾ãŸã¯åˆå›ï¼‰å ´åˆã€ç¾åœ¨æ™‚åˆ»ã‚’å–å¾—ã—ã¦ä¿å­˜
          NOW=$(date "+%Y/%m/%d %H:%M:%S")
          
          # ãƒ˜ãƒƒãƒ€ãƒ¼ï¼ˆæ—¥æ™‚ã¨ç©ºè¡Œï¼‰ã‚’ padlet_export.md ã«æ›¸ãè¾¼ã¿ï¼ˆä¸Šæ›¸ãï¼‰
          echo "æœ€çµ‚æ›´æ–°: $NOW" > padlet_export.md
          echo "" >> padlet_export.md
          
          # ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ãŸä¸­èº«ã‚’è¿½è¨˜
          cat temp_download.md >> padlet_export.md
          
          # ä¸€æ™‚ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‰Šé™¤
          rm temp_download.md
          
          echo "ğŸ”„ æ›´æ–°å®Œäº†: ãƒ‡ãƒ¼ã‚¿ãŒå¤‰æ›´ã•ã‚ŒãŸãŸã‚ä¿å­˜ã—ã¾ã—ãŸ ($NOW)"

      - name: å¤‰æ›´ã‚’ä¿å­˜
        run: |
          git config --global user.name "GitHub Action Bot"
          git config --global user.email "action@github.com"
          
          git add padlet_export.md
          
          if git diff --staged --quiet; then
            echo "å¤‰æ›´ãŒãªã‹ã£ãŸã®ã§ä½•ã‚‚ã—ã¾ã›ã‚“"
          else
            git commit -m "Padletã®æœ€æ–°ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—"
            # ã‚¨ãƒ©ãƒ¼å›é¿ã®ãŸã‚ pull ã‚’è¿½åŠ 
            git pull origin main --rebase
            git push
          fi
